---
title: "Using Star Ratings Data to Asses Which Medicare Part C Organizations perform best"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview and Motivation

### Motivation

We all want our parents and loved ones to recieve the best medical coverage possible. My parents are 2 years away from Medicare eligibility, and I want to take a data driven approach to finding which health insurance organizations provide the best service by analyzing Star Ratings Measurements. Medicare Part C is a program administered by the Center for Medicare and Medicaid Services (CMS) that combines Medicare Parts A and B (traditional Medicare) and optionally Part D (Prescription Drug Plan) through which beneficiaries recieve coverage through private insurance companies (United, Aetna, Humana, etc.) These insurance companies often offer greater benefits than what is offered through traditional Medicare, so it can be appealing to certain people based on their coverage needs. Enrollment in Medicare Part C has increased every year since 2005 and currently, approximately 34% of Medicare Benficiaries get their coverage through Part C^[https://www.kff.org/medicare/issue-brief/a-dozen-facts-about-medicare-advantage-in-2019/]

### Overview

CMS assigns the insurance contracts Category Star Ratings between 1-5 for various categories such as "Staying Healthy: Screenings, Tests and Vaccines" and "Managing Chronic (Long Term) Conditions." These categories are aggregated up to give a plan one final Star Rating. These insurance companies deeply care about having a higher Star Rating because they are rewarded lucrative benefits such as increased revenue and a longer enrollment period. Each of the Category Star Ratings is determined by sub-measures such as "Colorectal Cancer Screening," "Controlling Blood Pressure," and "Rheumatoid Arthritis Management."

It is these sub-measures that we will be analyzing.

# Initial Questions

There are three main questions (each with several sub-questions and paths we could go down) that we want to tackle:

* Are there certain insurance companies that perform better among certain measures? Which companies and which measures?

* Does the size of the enrollment in the contract play an impact in measures?

* For a person with specific needs due to a chronic condition, which plan features and/or organizations are the best choice to manage that condition?


# Data

There are three main data sets we are going to be pulling from:

* Enrollment information for Medicare Part C plans

* Contract information for Medicare Part C plans

* Star Rating data for Medicare Part C plans.

All of these data are publicly available through the CMS website^[https://www.cms.gov/Medicare/Prescription-Drug-Coverage/PrescriptionDrugCovGenIn/PerformanceData]. Initially the data seemed extremely messy with lots of missing values, but after a thorough investigation of the data it became much clearer. There are lots of smaller organizations with small and/or new contracts, and thus, the reporting requirements are more lenient. However, if we only consider contracts with >10,000 total enrollment and exclude certain specific plans (Demos and employer specific) the data is much cleaner while still covering 95% of total enrollment. Ultimately, when it comes to dealing with missing data, something has to give and unless you can develop imputation methods (impossible in this circumstance) we have to take what we are given. Furthermore, missing a few small/obscure contracts will not change the nature of the information, as this nice pie-chart from the Kaiser Family Foundation shows market dominance by the major players:

![](https://www.kff.org/wp-content/uploads/2019/06/9314-Figure-4.png)


### Data Importing and Joining.

Cleaning and organizing the data was not too intense. We had to recode a view values, perform some joins to get all the data together, and clean up values that were not reported and present them as NA so that R could digest them appropriately.

```{r message=FALSE, warning=FALSE}
library(tidyverse)

#Read in Enrollment data
data_main<- read_csv("C:\\Users\\Daniel\\Desktop\\MPC data\\CPSC_Enrollment_2019_09\\CPSC_Enrollment_Info_2019_09.csv")
data_main$enr= ifelse(data_main$Enrollment=='*',0,as.numeric(data_main$Enrollment))
```

```{r message=FALSE, warning=FALSE}
#Read in contract Information
contract_info = read_csv("C:\\Users\\Daniel\\Desktop\\MPC data\\CPSC_Enrollment_2019_09\\CPSC_Contract_Info_2019_09.csv")

```

```{r message=FALSE, warning=FALSE}
#Read in Star Ratings data
SR = read_csv("C:\\Users\\Daniel\\Desktop\\MPC data\\2018_Report_Card_Master_Table_2018_03_28_data_DW.csv")

```


```{r}
#Get enrollment by contract number
enrollment_data=data_main %>%
  group_by(`Contract Number`) %>%
  summarize(tot_enr=sum(enr)) %>%
  mutate(contract=`Contract Number`)
```

```{r}
#Get Unique contract information.
cntrct=contract_info %>%
  select(`Contract ID`,`Organization Type`, `Parent Organization`,`Contract Effective Date`)%>%
  distinct() %>%
  mutate(contract=`Contract ID`)
  
```


```{r}
#Inner join data
#EXCLUDE PLANS THAT ARE JUST PD, and where enrollment is 0
main_enr_data=inner_join(enrollment_data,cntrct, by='contract')%>%
  filter(`Organization Type` !='Medicare Prescription Drug Plan') %>%
  filter(tot_enr>0)
```

```{r}
#inner join SR data

SR2=SR%>%
  mutate(contract=CONTRACT_ID)%>%
  select (-c(`Organization Type`, `Parent Organization`))
full_data=inner_join(main_enr_data,SR2,by='contract')

#also create sub filter where enrollment is  > 10000.
#Also remove demo plans and employer specific plans (no data)
enr_10000=full_data %>%
  filter(tot_enr>10000) %>%
  filter(`Organization Type` !='Demo') %>%
  filter(`Organization Type` !='Employer/Union Only Direct Contract PDP')
#note this is still 95% of all enrollment so we are not missing much.
sum(enr_10000$tot_enr)/sum(full_data$tot_enr)
```


# Exploratory Analysis.

Manual inspection of the measures taken help us focus in on the specific questions we want to answer. To cover a broad range of categories/questions we will consider the following measures:


### **Measure of overall effectiveness**

* **Members Choosing to Leave the Plan:** This is not a perfect measure, as some areas have less plans operating in them, but seeing as how traditional Medicare is always an option, this measure should give information of how satisfied plan beneficiaries are.

* **Rating of Health Care Quality:** It is obvious why this is important.

* **Rating of Health Plan:** It is obvious why this is important.

* **Getting Needed Care:** Again, obvious why it's important.

### **Measures for Diabetes Care**

* **Diabetes Care - Eye Exam**

* **Diabetes Care - Kidney Disease Monitoring**

* **Diabetes Care - Blood Sugar Controlled**

* **Medication Adherence for Diabetes Medications.** Note this is only relevent for contracts offering Part D plans.

### **Measures for a person in good health with few/no chronic conditions**

* **Breast Cancer Screening**

* **Colorectal Cancer Screening**

* **Annual Flu Vaccine**

* **Improving or Maintaining Physical Health**

* **Improving or Maintaining Mental Health**

* **Monitoring Physical Activity**

* **Adult BMI Assessment**


We will also asses the **Plan Type, Plan Size, ** and **Parent Organization** to see if these factors have an effect.



Let us first finalize and clean the data.

```{r}
final_data=enr_10000 %>%
  rename(
    BCS=`C01: Breast Cancer Screening`
    ,CCS=`C02: Colorectal Cancer Screening`
    ,Flu=`C03: Annual Flu Vaccine`
    ,Phys=`C04: Improving or Maintaining Physical Health`
    ,MH=`C05: Improving or Maintaining Mental Health`
    ,Activity=`C06: Monitoring Physical Activity`
    ,BMI=`C07: Adult BMI Assessment`
    ,Leave=`C29: Members Choosing to Leave the Plan`
    ,Quality=`C25: Rating of Health Care Quality`
    ,PlanRating=`C26: Rating of Health Plan`
    ,GetCare=`C22: Getting Needed Care`
    ,DEye=`C13: Diabetes Care - Eye Exam`                                   
    ,DKid=`C14: Diabetes Care - Kidney Disease Monitoring`                     
    ,DSugar=`C15: Diabetes Care - Blood Sugar Controlled`
    ,DMed=`D11: Medication Adherence for Diabetes Medications`
    )%>%
  select(contract, tot_enr, `Organization Type`,`Parent Organization`,`Contract Effective Date`
         ,BCS
         ,CCS
         ,Flu
         ,Phys
         ,MH
         ,Activity
         ,BMI
         ,Leave
         ,Quality
         ,PlanRating
         ,GetCare
         ,DEye
         ,DKid
         ,DSugar
         ,DMed)

```



Let us first explore the effect of plan type on overal plan effectiveness.

* **Members Choosing to Leave the Plan:** This is not a perfect measure, as some areas have less plans operating in them, but seeing as how traditional Medicare is always an option, this measure should give information of how satisfied plan beneficiaries are.

* **Rating of Health Care Quality:** It is obvious why this is important.

* **Rating of Health Plan:** It is obvious why this is important.

* **Getting Needed Care:** Again, obvious why it's important.

```{r}
# Get plan type and effectivness.
#TWO SAMPLE T TEST FOR PLAN TYPE AND LEAVE

distinct(final_data,`Organization Type`)

lccp_data= final_data %>%
  filter(`Organization Type`=="Local CCP")%>%
  filter(Leave != "Plan too new to be measured" & Leave !="Not enough data available" & Leave !="Plan too small to be measured" )

rccp_data= final_data %>%
  filter(`Organization Type`=="Regional CCP")%>%
  filter(Leave != "Plan too new to be measured" & Leave !="Not enough data available" & Leave !="Plan too small to be measured" )

data_1876=final_data %>%
  filter(`Organization Type`=="1876 Cost")%>%
  filter(Leave != "Plan too new to be measured" & Leave !="Not enough data available" & Leave !="Plan too small to be measured" )


lccp=as.numeric(substr(lccp_data$Leave,1,nchar(lccp_data$Leave)-1))
rccp=as.numeric(substr(rccp_data$Leave,1,nchar(rccp_data$Leave)-1))
e1876=as.numeric(substr(data_1876$Leave,1,nchar(data_1876$Leave)-1))
pt_ttest1 <- t.test(lccp,rccp, var.equal = TRUE)
pt_ttest1

pt_ttest2 <- t.test(lccp,e1876, var.equal = TRUE)
pt_ttest2

pt_ttest3 <- t.test(rccp,e1876, var.equal = TRUE)
pt_ttest3

```


```{r}
# Get plan type and effectivness.
#TWO SAMPLE T TEST Now do the same QUALITY Measure

lccp_data= final_data %>%
  filter(`Organization Type`=="Local CCP")%>%
  filter(Quality != "Plan too new to be measured" & Quality !="Not enough data available" & Quality !="Plan too small to be measured" )

rccp_data= final_data %>%
  filter(`Organization Type`=="Regional CCP")%>%
  filter(Quality != "Plan too new to be measured" & Quality !="Not enough data available" & Quality !="Plan too small to be measured" )

data_1876=final_data %>%
  filter(`Organization Type`=="1876 Cost")%>%
  filter(Quality != "Plan too new to be measured" & Quality !="Not enough data available" & Quality !="Plan too small to be measured" )


lccp=as.numeric(lccp_data$Quality)
rccp=as.numeric(rccp_data$Quality)
e1876=as.numeric(data_1876$Quality)
pt_ttest1 <- t.test(lccp,rccp, var.equal = TRUE)
pt_ttest1

pt_ttest2 <- t.test(lccp,e1876, var.equal = TRUE)
pt_ttest2

pt_ttest3 <- t.test(rccp,e1876, var.equal = TRUE)
pt_ttest3

```

```{r}
# Get plan type and effectivness.
#TWO SAMPLE T TEST Now do the same PLANRATING Measure

lccp_data= final_data %>%
  filter(`Organization Type`=="Local CCP")%>%
  filter(PlanRating != "Plan too new to be measured" & PlanRating !="Not enough data available" & PlanRating !="Plan too small to be measured" )

rccp_data= final_data %>%
  filter(`Organization Type`=="Regional CCP")%>%
  filter(PlanRating != "Plan too new to be measured" & PlanRating !="Not enough data available" & PlanRating !="Plan too small to be measured" )

data_1876=final_data %>%
  filter(`Organization Type`=="1876 Cost")%>%
  filter(PlanRating != "Plan too new to be measured" & PlanRating !="Not enough data available" & PlanRating !="Plan too small to be measured" )


lccp=as.numeric(lccp_data$PlanRating)
rccp=as.numeric(rccp_data$PlanRating)
e1876=as.numeric(data_1876$PlanRating)
pt_ttest1 <- t.test(lccp,rccp, var.equal = TRUE)
pt_ttest1

pt_ttest2 <- t.test(lccp,e1876, var.equal = TRUE)
pt_ttest2

pt_ttest3 <- t.test(rccp,e1876, var.equal = TRUE)
pt_ttest3

```



```{r}
# Get plan type and effectivness.
#TWO SAMPLE T TEST Now do the same GETCARE Measure

lccp_data= final_data %>%
  filter(`Organization Type`=="Local CCP")%>%
  filter(GetCare != "Plan too new to be measured" & GetCare !="Not enough data available" & GetCare !="Plan too small to be measured" )

rccp_data= final_data %>%
  filter(`Organization Type`=="Regional CCP")%>%
  filter(GetCare != "Plan too new to be measured" & GetCare !="Not enough data available" & GetCare !="Plan too small to be measured" )

data_1876=final_data %>%
  filter(`Organization Type`=="1876 Cost")%>%
  filter(GetCare != "Plan too new to be measured" & GetCare !="Not enough data available" & GetCare !="Plan too small to be measured" )


lccp=as.numeric(lccp_data$GetCare)
rccp=as.numeric(rccp_data$GetCare)
e1876=as.numeric(data_1876$GetCare)
pt_ttest1 <- t.test(lccp,rccp, var.equal = TRUE)
pt_ttest1

pt_ttest2 <- t.test(lccp,e1876, var.equal = TRUE)
pt_ttest2

pt_ttest3 <- t.test(rccp,e1876, var.equal = TRUE)
pt_ttest3

```



```{r}

#Now let's run a linear regression to try and see what factors are good for diabetes care.






```


























